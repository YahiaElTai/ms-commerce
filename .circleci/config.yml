version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.1
  gcp-cli: circleci/gcp-cli@2.4.1

executors:
  gcp-executor:
    docker:
      - image: cimg/gcp:2022.11
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD

jobs:
  deploy_manifests:
    executor: gcp-executor
    steps:
      - checkout
      - gcp-cli/initialize
      - run:
          name: Connect to cluster
          command: gcloud container clusters get-credentials $CLUSTER_NAME --zone $GOOGLE_COMPUTE_ZONE --project $GOOGLE_PROJECT_ID
      - run:
          name: Apply all k8s manifests
          command: kubectl apply -f infra/k8s

workflows:
  check-service-changed:
    jobs:
      - path-filtering/filter:
          name: check-service-changed
          mapping: |
            cart/.* cart-changed true
            auth/.* auth-changed true
            infra/k8s/.* infra-changed true
          base-revision: main
          config-path: .circleci/workflows.yml
  deploy_manifests:
    when:
      equal: [main, << pipeline.git.branch >>]
    jobs:
      - deploy_manifests:
          type: approval
